<!--
    File Name: messages.html
    Created By: Wyatt Bechtle
    Created On: 10/02/2025
    Purpose: To provide messaging capabilities to the loreweave application.

    Updated By:   Wyatt Bechtle
    Update Notes: Built the initial version of the messages.html template.

    Updated By:   Wyatt Bechtle
    Update Notes: Integrated WebSocket functionality for real-time messaging.
                  Implemented both public and private messaging features using STOMP over SockJS.

    Updated By:   Chris Ennis
    Update Notes: Refactored WebSocket client to a single instance, improved message display,
                  and fixed DOM issues causing the message form to disappear.

    Updated By:   Wyatt Bechtle
    Update Notes: Refactored logic and fell back a commit to fix message display issues.
-->
<!doctype html>
<html lang="en" xmlns:th="https://www.thymeleaf.org/" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>messages</title>
    <!-- Bootstrap CSS -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
        crossorigin="anonymous">
      <!-- Bootstrap icons -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
            rel="stylesheet">
      <!-- Loreweave global styles -->
      <link rel="stylesheet" th:href="@{/css/styles.css}">

    <!-- STOMP and SockJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>

    <!-- WebSocket Client Setup -->
    <script th:inline="javascript">
      /*<![CDATA[*/
      // Declare client
      let client;
      const username = /*[[${#authentication.principal.username}]]*/ '';

      // Connect to WebSocket
      client = Stomp.over(new SockJS('/ws'));
      client.connect({}, () => {
        // Subscribe to public topic
        client.subscribe('/topic/messages', (res) => show(JSON.parse(res.body)));
        // Subscribe to private queue
        client.subscribe('/user/queue/notifications', (res) => show(JSON.parse(res.body)));
      });

      // Send functions
      function sendMessage() {
        // Get text and recipient values
        const text = document.getElementById('content').value;
        const to   = document.getElementById('to').value;

        // Send to server
        if (to) {
          client.send('/app/private', {}, JSON.stringify({ text, to }));
        } else {
          client.send('/app/application', {}, JSON.stringify({ text }));
        }
        document.getElementById('content').value = '';
      }
      // Helper functions
      function formatStamp(ts) {

        if (!ts) return '';

        // Try to parse timestamp
        const d = new Date(ts);

        // Return formatted date if valid
        if (!isNaN(d)) {
          return d.toLocaleString(undefined, { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
        }
        // Fallback to raw timestamp
        return String(ts);
      }

     // Build message element to look like speech bubbles
      function buildMessageEl({ message, createdAt, from }) {
  const wrap = document.createElement('div');
  wrap.className = from === username ? 'text-end' : 'text-start';

  const bubble = document.createElement('div');
  bubble.className = 'msg' + (from === username ? ' msg--me' : '');
  bubble.textContent = message ?? '';

  const time = document.createElement('div');
  time.className = 'msg-time';
  time.textContent = formatStamp(createdAt);

  wrap.appendChild(bubble);
  wrap.appendChild(time);
  return wrap;
}

      // Display message in list
      function show(msg) {

        // Append to message list
        const list = document.getElementById('message-display');
        if (!list) return;
        list.appendChild(buildMessageEl(msg));
        list.scrollTop = list.scrollHeight;
      }
      /*]]>*/
    </script>
  </head>
  <body class="profile-body">

  <!-- Page transition overlay -->
  <div id="page-transition"></div>

  <!-- Shared fantasy navbar (same as profile) -->
  <div th:replace="~{fragments/navbar :: navbar}"></div>


  <!-- MAIN -->
  <main class="container-fluid py-4">
      <h1 class="h3 mb-3">
          <i class="bi bi-chat-dots me-2"></i>Messages
      </h1>

      <div class="row g-3">
          <!-- Conversations List -->
          <section class="col-12 col-lg-4 messages-conversations">

          <h2 class="h6 mb-2">Conversations</h2>
              <ul class="list-group"
                  th:if="${conversations}"
                  th:each="c : ${conversations}">
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                      <a class="text-decoration-none"
                         th:href="@{/messages/{id}(id=${c.id})}"
                         th:text="${c.otherPartyUsername}">username
                      </a>
                      <small class="text-muted"
                             th:text="${#temporals.format(c.lastMessageAt,'yyyy-MM-dd HH:mm')}">time
                      </small>
                  </li>
              </ul>
              <!-- No conversations notice -->
              <p class="text-muted"
                 th:if="${conversations == null or #lists.isEmpty(conversations)}">
                  No conversations.
              </p>
          </section>

          <!-- Active Conversation and Message Form -->
          <section class="col-12 col-lg-8 messages-thread">

          <h2 class="h6 mb-2"
                  th:text="${activeConversation != null ? activeConversation.otherPartyUsername : 'Thread'}">
                  Thread
              </h2>

              <!-- Messages Display -->
              <div id="message-display"
                   class="message-scroll mb-3">
                  <div th:each="n : ${messages}">
                      <div class="mb-2">
                          <div th:text="${n.message}">content</div>
                          <div class="small text-muted"
                               th:text="${#temporals.format(n.createdAt,'yyyy-MM-dd HH:mm')}">time</div>
                      </div>
                  </div>
                  <!-- No messages notice -->
                  <p class="text-muted mb-0"
                     th:if="${messages == null or #lists.isEmpty(messages)}">
                      No messages.
                  </p>
              </div>

              <!-- Message Form -->
              <form
                      onsubmit="sendMessage(); return false;"
                      method="post"
                      class="form-fantasy">
                  <!-- CSRF Token -->
                  <input type="hidden"
                         th:if="${_csrf != null}"
                         th:name="${_csrf.parameterName}"
                         th:value="${_csrf.token}"/>

                  <!-- To and Content Fields -->
                  <label for="to" class="form-label">To</label>
                  <input id="to"
                         name="to"
                         class="form-control mb-2"
                         placeholder="username"
                         th:value="${activeConversation != null} ? activeConversation.otherPartyUsername : ''"
                         required/>

                  <label for="content" class="form-label">Message</label>
                  <textarea id="content"
                            name="content"
                            class="form-control mb-3"
                            rows="2"
                            placeholder="Type a message..."
                            required></textarea>

                  <!-- Submit Button -->
                  <button class="btn btn-primary" type="submit">
                      <i class="bi bi-send me-2"></i>Send
                  </button>
              </form>
          </section>
      </div>
  </main>

  <!-- FOOTER (same as profile.html) -->
  <footer>
      <p>&copy; 2025 Loreweave | A world where every player becomes an author.</p>
  </footer>

  <!-- Transition script (same used elsewhere) -->
  <script>
      document.body.classList.add('fade-in');
      function startTransition(nextHref){
        const o = document.getElementById('page-transition');
        o && o.classList.add('show');
        setTimeout(() => { window.location.href = nextHref; }, 600);
      }
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a');
        if (!a) return;
        if (a.origin === location.origin && a.target !== '_blank') {
          e.preventDefault();
          startTransition(a.href);
        }
      });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
          crossorigin="anonymous"></script>
  </body>
</html>
