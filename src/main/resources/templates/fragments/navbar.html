<!--
/// ==========================================
/// File Name:    navbar.html
/// Created By:   Wyatt Bechtle
/// Created On:   2025-10-03
/// Purpose:      Provides a navigation bar for the web application.
///  Updated By:    Wyatt Bechtle
///  Update Notes:  Added notification bell with unread count
///
///  Updated By:    Wyatt Bechtle
///  Update Notes:  Refactored notBell to be static
///
///  Updated By:    Wyatt Bechtle
///  Update Notes:  Notifications and messages badge live updates:
///                   Made the notification bell and messages badges 
///                     render consistently in the navbar.
///                   Added a minimal STOMP/SockJS client in the navbar 
///                     fragment that subscribes to '/user/queue/notifications` 
///                     and increments both badges on incoming notifications.
///                   Ensured badges are always present in the DOM (hidden when count is zero) 
///                     so the client can update them without adding new server endpoints.
///
/// ==========================================
-->
<!-- ==========================================
     Fantasy Navbar Fragment (Unified Version)
     ========================================== -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<th:block th:fragment="navbar">
    <header>
        <nav class="fantasy-navbar">

            <!-- LEFT — Brand -->
            <div class="navbar-left">
                <a href="/" class="btn-fantasy">Loreweave</a>
            </div>

            <!-- CENTER — Main Navigation -->
            <div class="navbar-center">

                <a href="/profile" class="btn-fantasy">User Profile</a>

                <a href="/messages" class="btn-fantasy">
                    Messages
                    <!-- Unread messages badge -->
                    <span id="messagesBadge"
                          class="badge-pill"
                          th:classappend="${unreadCount == 0} ? ' hidden-badge' : ''"
                          th:text="${unreadCount}">0</span>
                </a>

                <a href="/stories" class="btn-fantasy">Stories</a>
                <a href="/characters" class="btn-fantasy">Characters</a>

                <!-- NOTIFICATION BELL -->
                <a id="notifBell" class="btn-fantasy position-relative">
                    <i class="bi bi-bell" style="font-size: 1.4rem;"></i>

                    <!-- Unread notifications badge -->
                    <span id="notifBadge"
                          class="badge-pill"
                          th:classappend="${unreadCount == 0} ? ' hidden-badge' : ''"
                          th:text="${unreadCount}">0</span>
                </a>

            </div>

            <!-- RIGHT — Sign Out -->
            <div class="navbar-right">
                <form th:action="@{/logout}" method="post" class="signout-form">
                    <input type="hidden"
                           th:if="${_csrf != null}"
                           th:name="${_csrf.parameterName}"
                           th:value="${_csrf.token}" />

                    <button type="submit" class="btn-fantasy">
                        <i class="bi bi-box-arrow-right me-2"></i>
                        Sign Out
                    </button>
                </form>
            </div>

        </nav>
    </header>

    <!-- ==============================
         Notification WebSocket Client
         ============================== -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        (function() {
            const notifBadge = document.getElementById('notifBadge');
            const messagesBadge = document.getElementById('messagesBadge');

            function bump(badge) {
                const current = parseInt(badge.textContent || '0') || 0;
                badge.textContent = current + 1;
                badge.classList.remove('hidden-badge');
            }

            if (!notifBadge && !messagesBadge) return;

            function startClient() {
                try {
                    const client = Stomp.over(new SockJS('/ws'));
                    client.connect({}, function () {

                        client.subscribe('/user/queue/notifications', function (msg) {
                            try {
                                JSON.parse(msg.body);
                                if (notifBadge) bump(notifBadge);
                                if (messagesBadge) bump(messagesBadge);
                            } catch (e) {
                                if (notifBadge) bump(notifBadge);
                                if (messagesBadge) bump(messagesBadge);
                            }
                        });

                    });
                } catch (e) {}
            }

            // Load SockJS/Stomp if missing
            function load(src, cb) {
                const s = document.createElement('script');
                s.src = src;
                s.onload = cb;
                document.head.appendChild(s);
            }

            const needSock = typeof SockJS === 'undefined';
            const needStomp = typeof Stomp === 'undefined';

            if (needSock) load('https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.js', function() {
                if (needStomp) load('https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js', startClient);
                else startClient();
            });
            else if (needStomp) load('https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js', startClient);
            else startClient();

        })();
        /*]]>*/
    </script>
</th:block>

</html>
