<!--
    File Name: story-part.html
    Created By: Wyatt Bechtle
    Created On: 10/11/2025
    Purpose: Template for displaying a story part with voting and continuation features.

    Updated By:   Wyatt Bechtle
    Update Notes: Improved layout and styling for better user experience.
                  Added Character name display.
  Updated By:   Jamie Coker
  Updated On:   2025-10-13
  Update Notes: Added logic to disable voting buttons once a user has already voted on a story part.
                Uses 'userHasVoted' flag from StoryPartController to toggle visibility.
                Displays an 'Already Voted' message when userHasVoted = true.

    Updated By:   Wyatt Bechtle
    Update Notes: Implemented JS to handle vote notifications - Perserves to DB and broadcasts to WS.
    Updated By:   Jamie Coker
Updated On:   2025-10-22
Update Notes: Added full voting alert UI system for Milestone 2 Week 3.
              Implemented LV001–LV005 error messages and success banner
              using Thymeleaf param checks. Integrated Bootstrap alert
              components with custom fantasy-themed styling, including
              glow effects, fade-out animation, and icon indicators.
              Alerts now appear after vote redirects to provide clear
              feedback for duplicate votes, invalid actions, missing
              story parts, transaction failures, and successful votes.

-->
<!doctype html>
<html lang="en" xmlns:th="https://www.thymeleaf.org/" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Story part</title>
      <!-- Bootstrap -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

      <!-- Loreweave custom fantasy theme -->
      <link rel="stylesheet" th:href="@{/css/styles.css}">
    <!-- Bootstrap icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" 
          rel="stylesheet">

    <!-- STOMP and SockJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>

    <!-- WebSocket Client Setup -->
    <script th:inline="javascript">
      /*<![CDATA[*/
      // Declare client
      let client;
      const username = /*[[${#authentication.principal.username}]]*/ '';

      // Connect to WebSocket
      client = Stomp.over(new SockJS('/ws'));
      client.connect({}, () => {});

      // Send notification function
      function sendNotification() {

        // Get text and recipient values
        const text = "New vote!";
        const to = document.getElementById("contr").textContent;

        // Send to server
        client.send('/app/private', {}, JSON.stringify({ text, to }));
      }
      /*]]>*/
      </script>
  </head>
  <body class="profile-body story-part-page">

  <!-- Global Flying Pages Background -->
  <video autoplay muted loop playsinline id="flyingpages-bg">
      <source src="/images/flyingpages.mov" type="video/mp4">
  </video>

  <!-- Page transition overlay -->
  <div id="page-transition"></div>

  <!-- Shared fantasy navbar (same as profile) -->
  <div th:replace="~{fragments/navbar :: navbar}"></div>

        <!-- Alerts go here -->
        <div class="container mt-3"> … </div>

        <div class="container py-4">

        <div class="row justify-content-center">
        <!-- Adjust the widths here -->
        <div class="col-12 col-md-10 col-lg-8 col-xl-7">
          <!-- Back to Story Link -->
          <p class="mb-2">
            <a class="link-light" 
              th:href="@{/story/{id}(id=${part.story.id})}"><i class="bi bi-arrow-left me-1"></i>Back to story
            </a>
          </p>
            <!-- ========================= -->
            <!-- ALERT MESSAGES FOR VOTING -->
            <!-- ========================= -->
            <div class="container mt-3">

                <!-- SUCCESS -->
                <div th:if="${param.success}"
                     class="alert alert-success lore-alert shadow-sm">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Vote recorded!</strong> Your lore points have been updated.
                </div>

                <!-- LV001 – Duplicate Vote -->
                <div th:if="${param.error} == 'LV001'"
                     class="alert alert-warning lore-alert shadow-sm">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>You already voted on this part.</strong> Each user can only vote once.
                </div>

                <!-- LV002 – StoryPart Not Found -->
                <div th:if="${param.error} == 'LV002'"
                     class="alert alert-danger lore-alert shadow-sm">
                    <i class="bi bi-x-circle-fill me-2"></i>
                    <strong>Story part not found.</strong> The content you attempted to vote on is unavailable.
                </div>

                <!-- LV003 – Self Vote -->
                <div th:if="${param.error} == 'LV003'"
                     class="alert alert-warning lore-alert shadow-sm">
                    <i class="bi bi-ban me-2"></i>
                    <strong>Not allowed.</strong> You cannot vote on your own contribution.
                </div>

                <!-- LV004 – Invalid Vote Type -->
                <div th:if="${param.error} == 'LV004'"
                     class="alert alert-danger lore-alert shadow-sm">
                    <i class="bi bi-x-octagon-fill me-2"></i>
                    <strong>Invalid vote option.</strong> Please try again.
                </div>

                <!-- LV005 – Transaction Failure -->
                <div th:if="${param.error} == 'LV005'"
                     class="alert alert-danger lore-alert shadow-sm">
                    <i class="bi bi-bug-fill me-2"></i>
                    <strong>Voting failed.</strong> A server issue prevented your vote. Try again soon.
                </div>

            </div>

            <!-- Part Details -->
          <h1 class="h4 mb-1">Part <span th:text="${part.partOrder}">1</span></h1>
          <p class="text-secondary small mb-3">
            By <span id="contr" th:text="${(part.contributor != null and part.contributor.user != null) ? part.contributor.user.username : 'unknown'}">contributor</span> · <span th:text="${part.createdAt != null ? #temporals.format(part.createdAt,'yyyy-MM-dd HH:mm') : '—'}">time</span>
            <br/>
            Featuring <span th:text="${part.contributor != null ? part.contributor.name : 'unknown'}">character</span>
          </p>
          <!-- Part Content -->
          <article class="bg-body-tertiary border rounded-3 p-3 mb-3" 
                  style="white-space:pre-wrap" 
                  th:text="${part.content}">Part content...
          </article>

          <!-- Voting Section -->
          <div class="d-flex align-items-center gap-2 mb-4">

              <!--  If user has NOT voted -->
              <div th:if="${!userHasVoted}" class="d-flex gap-2 vote-buttons">


              <!-- Upvote Form -->
            <form th:action="@{'/api/votes/' + ${part.id} + '?type=POSITIVE'}" 
                  method="post"
                  onsubmit="sendNotification()">
              <input type="hidden" 
                    name="type" 
                    value="POSITIVE">
              <input type="hidden" 
                    th:if="${_csrf != null}" 
                    th:name="${_csrf.parameterName}" 
                    th:value="${_csrf.token}">
              <button type="submit" 
                      class="btn btn-success"><i class="bi bi-hand-thumbs-up me-1"></i>Upvote
              </button>
            </form>

            <!-- Downvote Form -->
            <form th:action="@{'/api/votes/' + ${part.id} + '?type=NEGATIVE'}"
                  method="post"
                  onsubmit="sendNotification()">
              <input type="hidden" 
                    name="type" 
                    value="NEGATIVE">
              <input type="hidden" 
                    th:if="${_csrf != null}" 
                    th:name="${_csrf.parameterName}" 
                    th:value="${_csrf.token}">
              <button type="submit" 
                      class="btn btn-danger"><i class="bi bi-hand-thumbs-down me-1"></i>Downvote
              </button>
            </form>
              </div>

                  <!--  If the user ALREADY voted -->
                  <div th:if="${userHasVoted}">
                      <button class="btn btn-secondary" disabled>
                          <i class="bi bi-hand-thumbs-up me-1"></i>Already Voted
                      </button>
                  </div>


                  <!-- Vote Score and Total Votes -->
              <span class="vote-score ms-2">Score:
    <strong th:text="${voteScore}">0</strong>
</span>

              <span class="vote-total ms-2">Total votes:
    <span th:text="${totalVotes}">0</span>
</span>

          </div>  
        </div>
      </div>
    </div>
        <footer>
            <p>&copy; 2025 Loreweave | A world where every player becomes an author.</p>
        </footer>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" 
            crossorigin="anonymous">
    </script>
  <script>
      document.addEventListener("DOMContentLoaded", function () {
          const alerts = document.querySelectorAll(".alert");
          alerts.forEach(alert => {
              setTimeout(() => {
                  alert.classList.add("fade");
                  setTimeout(() => alert.remove(), 600);
              }, 3500);
          });
      });
  </script>
  </body>
</html>



